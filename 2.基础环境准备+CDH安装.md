# 安装包准备 todo 待上传

# 环境准备

## 配置hostName
**每台机器保证/etc/sysconfig/network 、/etc/hostname 中的hostname 保持一致**

```
[root@iZuf6bjtu5uncrd6kp1erqZ remoter]# hostnamectl set-hostname node1
[root@iZuf6bjtu5uncrd6kp1erqZ remoter]# hostname
node1

[root@iZuf6bjtu5uncrd6kp1erqZ remoter]# vim /etc/sysconfig/network
HOSTNAME=node1

[remoter@node1 ~]$ systemctl restart network
=================
[root@iZuf609wklcu891awtffklZ /]# hostnamectl set-hostname node2
[root@iZuf609wklcu891awtffklZ /]# vim /etc/sysconfig/network
HOSTNAME=node2

[remoter@node1 ~]$ systemctl restart network
```

## 配置ssh免密
remoter 普通用户配置即可

### 修改hosts：每台机器
```
[root@node1 .ssh]# vim /etc/hosts
172.19.36.9     node1
172.19.157.8    node2

```
### 主机器node1上生成秘钥：

```
[root@node1 .ssh]# su remoter
[remoter@node1 .ssh]$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/remoter/.ssh/id_rsa): 
/home/remoter/.ssh/id_rsa already exists.
Overwrite (y/n)? y
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/remoter/.ssh/id_rsa.
Your public key has been saved in /home/remoter/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:U1p6uvieyXa43WUbX/lha9QrfLpBhYRbKIfPC5XRhIw remoter@node1
The key's randomart image is:
+---[RSA 2048]----+
|          +.Oo   |
|         E O.o.  |
|          O o. . |
|         * +  .  |
|        S o ..  .|
|         + ..  .o|
|        ..  ..=+o|
|       oo=.. =oB=|
|      .+Oo. .oB.o|
+----[SHA256]-----+


[remoter@node1 .ssh]$ ssh-copy-id remoter@node2
[remoter@node1 .ssh]$ ssh-copy-id remoter@node1
```

测试：OK

```
[remoter@node1 .ssh]$ ssh node2
Last login: Mon Sep 23 16:21:05 2019 from 27.16.222.215

Welcome to Alibaba Cloud Elastic Compute Service !
[remoter@node2 ~]$ exit
logout
Connection to node2 closed.
[remoter@node1 .ssh]$ 
```

### 关闭防火墙
关闭命令：

```
systemctl stop firewalld
systemctl disable  firewalld
```


查看关闭结果：ok
```
[remoter@node1 .ssh]$ systemctl status firewalld
● firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)

```

### 设置ntpd 离线时间同步（同步于主节点）

```
[remoter@node1 .ssh]$ su root
Password: 
[root@node1 .ssh]# systemctl enable ntpd
Created symlink from /etc/systemd/system/multi-user.target.wants/ntpd.service to /usr/lib/systemd/system/ntpd.service.

# node1的 /etc/ntp.conf 添加

# 允许内网其他机器同步时间，如果不添加该约束默认不允许所有IP访问本机同步服务
restrict 172.19.0.0 mask 255.255.255.0 nomodify notrap
[root@node1 remoter]# systemctl restart ntpd
# node2 执行

[root@node2 remoter]# vim /etc/ntp.conf
#配置上游时间服务器为本地的ntpd Server服务器
server 172.19.36.9
# 配置允许上游时间服务器主动修改本机的时间
restrict 172.19.36.9 nomodify notrap noquery
[root@node2 etc]# sudo ntpdate -u 172.19.36.9
23 Sep 17:07:16 ntpdate[31717]: adjust time server 172.19.36.9 offset 0.003313 sec
[root@node2 etc]# systemctl restart ntpd

[root@node2 etc]# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 node1           100.100.5.1      3 u   29   64    1    1.333   26.830   0.000
+120.25.115.20   10.137.53.7      2 u   10   16    3   29.731   -1.389   0.592
 10.143.33.49    .INIT.          16 u    -   16    0    0.000    0.000   0.000
-100.100.3.1     10.137.55.181    2 u    8   16    3    4.245   -2.410   0.919
*100.100.3.2     10.137.55.181    2 u    7   16    3    7.276   -0.513   1.350
+100.100.3.3     10.137.55.181    2 u    6   16    3    5.175   -0.807   0.678
-203.107.6.88    10.137.55.181    2 u    5   16    3   21.211   -2.034   0.888
 10.143.33.50    .INIT.          16 u    -   16    0    0.000    0.000   0.000
 10.143.33.51    .INIT.          16 u    -   16    0    0.000    0.000   0.000
 10.143.0.44     .INIT.          16 u    -   16    0    0.000    0.000   0.000
 10.143.0.45     .INIT.          16 u    -   16    0    0.000    0.000   0.000
 10.143.0.46     .INIT.          16 u    -   16    0    0.000    0.000   0.000
-100.100.5.1     10.137.55.181    2 u    7   16    1    5.296   -2.083   0.684
+100.100.5.2     10.137.55.181    2 u    6   16    1    4.506   -0.918   0.390
+100.100.5.3     10.137.55.181    2 u    5   16    1    6.962   -1.074   0.687

```

### 安装Oracle版本的jdk1.8
每台机器上执行以下命令：前提是下载好tar包

```
[root@node1 home]# mkdir /home/java
[root@node1 home]# chmod -R 777 /home/java/
[root@node1 home]# cd /home/java/
[root@node1 java]# tar -zxvf jdk-8u191-linux-x64.tar.gz 
[root@node1 java]# vim /etc/profile

#java environment
export JAVA_HOME=/home/java/jdk1.8.0_191
export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$PATH:$JAVA_HOME/bin

[root@node1 java]# source /etc/profile
[root@node1 java]# java -version
java version "1.8.0_191"
Java(TM) SE Runtime Environment (build 1.8.0_191-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)

```

备注：这里通过rz命令上传文件：
安装rz命令

```
yum install lrzsz
```

### 安装mysql5.7版本
下载包mysql-5.7.21-1.el7.x86_64.rpm-bundle.tar

```
[root@node1 mysql]# tar -xvf mysql-5.7.21-1.el7.x86_64.rpm-bundle.tar

```

1. 卸载掉centos7自带的mariadb-lib

```
 yum remove mysql-libs
```
 
2. 安装mysql-server服务，只需要安装如下4个软件包即可

```
[root@node1 mysql]# rpm -ivh mysql-community-common-5.7.21-1.el7.x86_64.rpm 
[root@node1 mysql]# rpm -ivh mysql-community-libs-5.7.21-1.el7.x86_64.rpm

[root@node1 mysql]#  rpm -ivh mysql-community-client-5.7.21-1.el7.x86_64.rpm 
[root@node1 mysql]# rpm -ivh mysql-community-server-5.7.21-1.el7.x86_64.rpm 

```
可能报错：

```
[root@node1 mysql]# rpm -ivh mysql-community-server-5.7.21-1.el7.x86_64.rpm
warning: mysql-community-server-5.7.21-1.el7.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY
error: Failed dependencies:

```

解决办法：

```
yum install wget
wget http://mirror.centos.org/centos/6/os/x86_64/Packages/libaio-0.3.107-10.el6.x86_64.rpm
yum install net-tools
```


 

3. 数据库初始化
**注意：初始化后会在/var/log/mysqld.log生成随机密码**
```
[root@node1 mysql]# mysqld --initialize 
[root@node2 mysql]# chmod -R 777 /var/lib/mysql

```
 
4. 启动mysql 服务，登录mysql 修改密码以及允许远程权限

```
systemctl start mysqld.service
systemctl status mysqld.service

[root@node1 ~]# mysql -uroot -p
# mysql 的初始化密码在/var/log/mysqld.log
2019-09-25T05:32:07.462393Z 1 [Note] A temporary password is generated for root@localhost: hXfp(qrSZ7Rn

#修改root 密码
mysql> SET PASSWORD = PASSWORD('123456'); 
Query OK, 0 rows affected, 1 warning (0.00 sec)




```



# CDH安装
上传文件包解压

```
[root@node1 home]# unzip cdh5.16.1.zip 

[root@node1 cdh5.16.1]# cd cdh5.16.1
[root@node1 cdh5.16.1]# sudo tar -zxvf cloudera-manager-centos7-cm5.16.1_x86_64.tar.gz
[root@node1 cdh5.16.1]# mv cloudera/ /opt/
[root@node1 cdh5.16.1]# mv cm-5.16.1/ /opt/
[root@node1 cdh5.16.1]# cp CDH-5.16.1-1.cdh5.16.1.p0.3-el7.parcel /opt/cloudera/parcel-repo/
[root@node1 cdh5.16.1]# cp CDH-5.16.1-1.cdh5.16.1.p0.3-el7.parcel.sha1 /opt/cloudera/parcel-repo/
[root@node1 cdh5.16.1]# cp manifest.json /opt/cloudera/parcel-repo/

[root@node1 cdh5.16.1]# cd /opt/cloudera/parcel-repo/
[root@node1 parcel-repo]# mv CDH-5.16.1-1.cdh5.16.1.p0.3-el7.parcel.sha1 CDH-5.16.1-1.cdh5.16.1.p0.3-el7.parcel.sha

```
配置Agent：


```
[root@node1 parcel-repo]# cd /opt/cm-5.16.1/etc/cloudera-scm-agent/
[root@node1 cloudera-scm-agent]# vim config.ini
```
config.ini 添加：server_host为主节点的主机

```
server_host=172.19.36.9
```

准备mysql包：

```
[root@node1 share]# cd /usr/share/
[root@node1 share]# mkdir java
[root@node1 share]# chmod -R 777 java/
[root@node1 share]# cd java/
rz上传mysql jar
[root@node1 java]# mv mysql-connector-java-5.1.46.jar  /usr/share/java/mysql-connector-java.jar
[root@node1 java]# chmod -R 777 mysql-connector-java.jar
```

将cm-5.16.1 文件夹拷贝到其他节点

```
cd /opt/
tar czvf cm-5.16.1.tar cm-5.16.1/
[root@node1 opt]# scp -r /opt/cm-5.16.1.tar  node2:/opt/

[remoter@node1 opt]$ ssh node2
[root@node2 opt]# tar -zxvf cm-5.16.1.tar 
[root@node2 opt]# chown -R remoter:remoter cm-5.16.1
```
连接mysql 创建scm用户并配置允许远程权限：

```
[root@node1 ~]# mysql -uroot -p

创建scm用户并赋允许远程权限
mysql> CREATE USER 'scm'@'localhost' IDENTIFIED BY '123456';
Query OK, 0 rows affected (0.01 sec)

mysql> grant all privileges on *.* to root@'%' identified by '123456';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> flush privileges;
Query OK, 0 rows affected (0.13 sec)

mysql> create database scm DEFAULT CHARSET utf8 COLLATE utf8_general_ci ;
Query OK, 1 row affected (0.00 sec)
```


修改server的数据库配置

```
cd /opt/cm-5.16.1/etc/cloudera-scm-server

vim db.properties
```
db.properties：

```
com.cloudera.cmf.db.type=mysql
com.cloudera.cmf.db.host=172.19.157.8
com.cloudera.cmf.db.name=scm
com.cloudera.cmf.db.user=root
com.cloudera.cmf.db.setupType=EXTERNAL
com.cloudera.cmf.db.password=123456
```
启动agent 和server：

node1：
```
[root@node1 cloudera-scm-server]# cd /opt/cm-5.16.1/etc/init.d/
[root@node1 init.d]# ./cloudera-scm-server start
install: invalid user ‘cloudera-scm’
Starting cloudera-scm-server:                              [  OK  ]
[root@node1 init.d]# ./cloudera-scm-agent start
Starting cloudera-scm-agent:                               [  OK  ]

```
node2：

```
[root@node2 init.d]# cd /opt/cm-5.16.1/etc/init.d
[root@node2 init.d]# ./cloudera-scm-agent start
Starting cloudera-scm-agent:                               [  OK  ]

```
通过日志发现：
```
[root@node1 cloudera-scm-server]# mkdir /var/lib/cloudera-scm-server
[root@node1 cloudera-scm-server]# chmod -R 777 /var/lib/cloudera-scm-server

```


---

安装 启动 Cloudera Management Service：getpwnam(): name not found: cloudera-scm

解决办法创建cloudera-scm 用户：
```
useradd --system --home=/opt/cm-5.16.1/run/cloudera-scm-server --no-create-home --shell=/bin/false --comment "Cloudera SCM User" cloudera-scm

```

报错：

```
 pstree: command not found
```
解决办法:

```
yum install psmisc -y 
```
